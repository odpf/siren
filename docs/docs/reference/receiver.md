import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";
import CodeBlock from '@theme/CodeBlock';
import siteConfig from '/docusaurus.config.js';

# Receiver

export const apiVersion = siteConfig.customFields.apiVersion
export const defaultHost = siteConfig.customFields.defaultHost

Receiver represents a notification medium, which can be used to define notification routing configuration in Siren. Siren currently supports several type of receivers. Here is receiver [schema](../concepts/schema.md#receivers). The `type` of stored receiver in the DB is immutable.

- [Slack](#slack)
- [PagerDuty](#pagerduty)
- [HTTP](#http)
- [File](#file)

Configuration of each receiver depends on the type itself. This page describes all configurations for various receivers that Siren supports.

## Slack

`Type: slack`

### Configurations in API

```json
"configurations": {
    "client_id": <string>
    "client_secret": <string>,
    "auth_code": <string>
}
```

### Configurations Stored in DB

```json
"configurations": {
    "token": <encrypted string>
}
```


Creating a slack receiver involves exchanging the auth code for a token with slack oAuth server. Siren will need the auth code, client id, client secret and optional label metadata.

**Example**

<Tabs groupId="api">
  <TabItem value="cli" label="CLI" default>

```bash
$ siren receiver create --file slack_receiver.yaml
```

  </TabItem>
  <TabItem value="http" label="HTTP">
    <CodeBlock className="language-bash">
    {`$ curl --request POST
  --url `}{defaultHost}{`/`}{apiVersion}{`/receivers
  --header 'content-type: application/json'
  --data-raw '{
    "name": "doc-slack-receiver",
    "type": "slack",
    "labels": {
        "team": "siren-devs"
    },
    "configurations": {
        "client_id": "abcd",
        "client_secret": "xyz",
        "auth_code": "123"
    }
}'`}
    </CodeBlock>
  </TabItem>
</Tabs>

On success, this will store the encrypted app token for that particular slack workspace and use it for sending out notifications.

**Permissions and Auth Settings for Slack Receivers**

In order to send Slack notifications via Siren API, you need to create its receiver. This Slack app then must be
installed in the required workspaces and added to the required channels.

Siren helps with the installation flow by automating the exchanging code for access token
flow. [Reference](https://api.slack.com/legacy/oauth#authenticating-users-with-oauth__the-oauth-flow).

Here is the list of actions one need to take to attach a Slack app to Siren.

1. Create a Slack app with these permissions. Visit [this](https://api.slack.com/apps). If you already have an app, make
   sure permissions mentioned below are there.
2. Configure these permissions in the app:

   ```text
    channels:read
    chat:write
    groups:read
    im:read
    team:read
    users:read
    users:read.email
   ```

3. Enable Distribution
4. Setup a redirection server. You can use localhost as well. This must be a https server. Slack will call this server
   once we install the app in any workspace.
5. Install your app to a workspace. Visit `Manage Distribution` section on the App Dashboard. Click the `Add to Slack` Button.
6. This will prompt you to the OAuth Consent screen. Make sure you have selected the correct Slack Workspace by
   verifying the dropdown in the top-right corner. Click Allow.
7. Copy the `code` that you received from Slack redirection URL query params and use this inside create receiver payload.


### Message Payload Format

```yaml
channel: <string>
text: <string>
username: <string>
icon_emoji: <string>
icon_url: <string>
link_names: <boolean>
attachments:
  - <key1>: <any>
    <key2>: <any>
  - <key3>: <any>
    <key4>: <any>
    .
    .
```

Payload format above follow [slack chat.postMessage API](https://api.slack.com/methods/chat.postMessage) contract.

Using a slack receiver you will be able to send out Slack notification using its send API. You can also use it to route alerts using Subscriptions whenever an alert matches the conditions of your choice. Check the required permissions of the Slack App [here](./receiver.md#permissions-and-auth-settings-for-slack-receivers).


### Message Payload Templating

**Cortex Alert Template**

Siren has a slack default [template](../../../plugins/receivers/slack/config/default_cortex_alert_template_body.goyaml) for all notifications generated by Cortex Alert.

## PagerDuty

`Type: pagerduty`

### Configurations in API

```json
"configurations": {
    "service_key": <string>
}
```

### Message Payload Format

Pagerduty has v1 and v2 events API. What Siren's support currently is sending event to PagerDuty events v1 API.

```yaml
# v1
service_key: <string>
event_type: <string>
incident_key: <string>
description: <string>
client: <string>
client_url: <string>
details:
  - <key1>: <any>
    <key2>: <any>
  - <key3>: <any>
    <key4>: <any>
    .
    .
contexts:
  - type:  <string>
    src:  <string>
    href:  <string>
    text:  <string>
    alt:  <string>
  - type:  <string>
    src:  <string>
    href:  <string>
    text:  <string>
    alt:  <string>
    .
    .
```

### Message Payload Templating

**Cortex Alert Template**

Siren has a PagerDuty default [template](../../../plugins/receivers/pagerduty/config/default_cortex_alert_template_body_v1.goyaml) for all notifications generated by Cortex Alert.

## HTTP

`Type: http`

### Configurations in API

```json
"configurations": {
  "url": <string>
}
```

### Message Payload Format
Payload will be sent as-is. If defined by [templates](./templates.md), payload will be the same with the generated payload by template.

## File

`Type: file`

File receiver write down outgoing notifications to a file located with an `url` in the configurations.

### Configurations in API

The `url` below should be file path url e.g. `./folder_a/folder_b/file.json`.

```json
"configurations": {
  "url": <string>
}
```

### Message Payload Format
Payload will be written to file as-is in `ndjson` format.
